
@using System.IO
@using System.Linq.Expressions

@using WebHome.Helper
@using WebHome.Models.Locale
@using WebHome.Models.ViewModel
@using WebHome.Models.DataEntity
@using WebHome.Controllers
@using Microsoft.AspNetCore.Mvc.ModelBinding
@{

    ModelStateDictionary _modelState;
    ModelSource<UserProfile> models;
    UserProfile _model;
    CalendarEventViewModel _viewModel;
    UserProfile _profile;

    BookingLessonPageModel _pageModel = (BookingLessonPageModel)ViewBag.PageModel;

    _modelState = ViewContext.ModelState;
    models = (ModelSource<UserProfile>)ViewContext.HttpContext.Items["Models"];;
    _model = (UserProfile)this.Model;
    _viewModel = (CalendarEventViewModel)ViewBag.ViewModel;
    _profile = await Context.GetUserAsync();
    LessonPriceType price = models.CurrentTrialLessonPrice();
    var attendedCheck = models.GetTable<LessonTime>()
        .Join(models.GetTable<GroupingLesson>()
        .Join(models.GetTable<RegisterLesson>()
        .Where(r => r.UID == _model.UID),
        g => g.GroupID, r => r.RegisterGroupID, (g, r) => g),
        l => l.GroupID, g => g.GroupID, (l, g) => l);
}

@{
    if (price != null && (!attendedCheck.Any() || _model.UserProfileExtension.CurrentTrial.HasValue))
    {
        var trialLesson = models.GetTable<RegisterLesson>()
                .Where(r => r.UID == _model.UID)
                .Where(r => r.LessonPriceType.Status == (int)Naming.LessonPriceStatus.體驗課程)
                .Where(r => !r.BranchStore.Status.HasValue || (r.BranchStore.Status & (int)BranchStore.StatusDefinition.VirtualClassroom) == 0);
        var trialLessonItem = trialLesson.FirstOrDefault();
        var trialBookable = trialLessonItem == null;

        //if (trialBookable)
        //{
        //    _pageModel.HasChoice = true;
        //}

        <li class="list-group-item">
            <div class="media">
                <div class="pull-left">
                    <div class="controls">
                        <label class="fancy-checkbox">
                            <input type="checkbox" @(trialBookable ? null : "disabled") name="RegisterID" id="trialLesson" value="" onclick="selectBooking(this, '@((int)Naming.LessonPriceStatus.體驗課程)', @(price?.PriceID ?? -1));">
                            <span></span>
                        </label>
                    </div>
                </div>
                <div class="media-body">
                    <div class="media-heading">
                        <a class="m-r-10">T.S Session(60分鐘)</a>
                        <small class="float-right text-muted"><time>@(trialBookable ? 1 : 0)/1</time></small>
                        <div class="msg">
                            <span class="float-right">
                                <span class="badge bg-blue"><i class="zmdi zmdi-pin"></i> 現場</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </li>
    }
    <li class="list-group-item">
            <div class="media">
                <div class="pull-left">
                    <div class="controls">
                        <label class="fancy-checkbox">
                            <input type="checkbox" name="RegisterID" value=""
                                onclick="selectBooking(this, '@((int)Naming.LessonPriceStatus.體驗課程)',385);">
                            <span></span>
                        </label>
                    </div>
                </div>
                <div class="media-body">
                    <div class="media-heading">
                        <a class="m-r-10">
                            S.R Session(40分鐘)
                        </a>
                        <small class="float-right text-muted"><time>NT 300</time></small>
                        <div class="msg">
                            <span class="float-right">
                                <span class="badge bg-blue"><i class="zmdi zmdi-pin"></i> 現場</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
    </li>
}