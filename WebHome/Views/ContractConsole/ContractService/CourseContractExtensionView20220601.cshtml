
@using System.IO
@using System.Linq.Expressions

@using WebHome.Helper
@using WebHome.Models.Locale
@using WebHome.Models.ViewModel
@using WebHome.Models.DataEntity
@using WebHome.Controllers
@using Microsoft.AspNetCore.Mvc.ModelBinding
@using WebHome.Properties
@using WebHome.Helper.BusinessOperation
@{

    ModelStateDictionary _modelState;
    ModelSource<UserProfile> models;
    CourseContractRevision _model;
    CourseContractMember _owner;
    CourseContract _contract;
    DateTime? _signatureDate;
    CourseContract _original;

    CourseContractViewModel _viewModel = (CourseContractViewModel)ViewBag.ViewModel;

    _modelState = ViewContext.ModelState;
    models = (ModelSource<UserProfile>)ViewContext.HttpContext.Items["Models"];;
    _model = (CourseContractRevision)this.Model;
    _contract = _model.CourseContract;
    _original = _model.SourceContract;
    _owner = _contract.CourseContractMember.Where(m => m.UID == _contract.OwnerID).First();
    var item = _contract.CourseContractLevel.Where(l => l.LevelID == (int)Naming.CourseContractStatus.待審核).FirstOrDefault();
    if (item != null)
    {
        _signatureDate = item.LevelDate;
    }
    else
    {
        _signatureDate = DateTime.Now;
    }
}
<div class="row" style="@(_viewModel.Pdf == "1" ? "width: 21.5cm; height: 28cm;margin-top: 20px;margin-bottom: 5px;" : "margin-top: 20px;margin-bottom: 5px;")"">
    <div class="col-md-12">
        <div style="font-size: 15px">
            <h4 class="text-center" style="margin-bottom: 0px"><b>Beyond Fitness 顧問服務展延申請書</b></h4>
            <table class="table">
                <tbody>
                    <tr>
                        <td colspan="2">合約編號：@(_contract.ContractNo())</td>
                    </tr>
                    <tr style="border-width: 1px; border-top-style: dashed;">
                        <td colspan="2">學員資料</td>
                    </tr>
                    @{
                        IEnumerable<CourseContractMember> items;
                    }
                    @if (_original.ContractType == (int)CourseContractType.ContractTypeDefinition.CFA
                        || _original.ContractType == (int)CourseContractType.ContractTypeDefinition.CGF
                        || _original.ContractType == (int)CourseContractType.ContractTypeDefinition.CVF)
                    {
                        items = _original.CourseContractMember.Where(m => m.UID == _original.OwnerID); 
                    }
                    else
                    {
                        items = _original.CourseContractMember;
                    }
                    @foreach (var m in items)
                    {
                        <tr>
                            <td>姓名：@(m.UserProfile.RealName)</td>
                            <td>身份證字號/護照號碼：@(m.UserProfile.UserProfileExtension.IDNo)</td>
                        </tr>
                        <tr>
                            <td>性別：@(m.UserProfile.UserProfileExtension.Gender == "F" ? "女" : "男")</td>
                            <td>聯絡電話：@(m.UserProfile.Phone)</td>
                        </tr>                                          
                    } 
                    <tr style="border-width: 1px; border-top-style: dashed;">
                        <td colspan="2">原合約內容</td>
                    </tr>
                    <tr>
                        <td>名稱：@(_original.CourseContractType.TypeName)(@(_original.LessonPriceType.DurationInMinutes)分鐘)</td>
                        <td>
                            @if (_original.LessonPriceType.BranchStore?.IsVirtualClassroom() == true)
                            {
                                <text>上課場所/簽約分店：遠距/@(_original.CourseContractExtension.BranchStore.BranchName)</text>
                            }
                            else
                            {
                                <text>上課場所：@(_original.CourseContractExtension.BranchStore.BranchName)</text>
                            }
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">購買堂數：共@(_original.Lessons)堂<br/>
                            <p style="margin-left: 60px;margin-bottom: 0px;">@Html.Raw(String.Join("<br/>",_original.ExpandContractLessonDetails(models, "■")))</p>
                        </td>
                     </tr>                    
                    <tr>
                        <td colspan="2">顧問服務使用期限：自 @(String.Format("{0:yyyy/MM/dd}", _original.ValidFrom)) 起，至 @(String.Format("{0:yyyy/MM/dd}", _original.Expiration)) 止。</td>                        
                    </tr>
                    <tr style="border-width: 1px; border-top-style: dashed;">
                        <td colspan="2">服務申請內容：</td>
                    </tr>
                    <tr>
                        <td colspan="2">申請日期：@(String.Format("{0:yyyy/MM/dd}", _contract.ContractDate))</td>                        
                    </tr>                    
                    <tr>
                        <td>項目：展延</td>
                        <td>相關證明文件：
                            @if (_model.AttachmentID.HasValue)
                                {
                                    <u><a href="@Html.Raw($"{WebHome.Startup.Properties["HostDomain"]}{Url.Action("GetResourceWithMime","Information",new { HKeyID =_model.AttachmentID.Value.EncryptHexKey() })}")" target="_blank">開啟附件</a></u>
                                }
                        </td>
                    </tr>    
                    <tr>
                        <td colspan="2">申請說明：契約到期日由 @(String.Format("{0:yyyy/MM/dd}", _original.Expiration))  ，展延至 <sapn class="col-red">@(String.Format("{0:yyyy/MM/dd}", _contract.Expiration))</sapn> 止
                        @if (_contract.Remark !=null)
                        {
                            <text>（@(_contract.Remark)）。</text>
                        }</td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            備註：各項申請內容皆應依體能顧問聘請合約之規定辦理並經雙方簽署後始生效力。
                        </td>  
                    </tr>                        
                </tbody>
            </table>                       
            <div style="@(_viewModel.Pdf == "1" ? "position: absolute;bottom: 0px" : "bottom: 0px")"">
                <table class="table" style="margin-bottom: 0px">
                    @if (_viewModel.Pdf != "1" && _contract.CourseContractExtension.SignOnline == true)
                    {
                        <tr>
                            <td>
                                <label class="fancy-checkbox  custom-bgcolor-green">
                                    <input type="checkbox" checked="checked" disabled="disabled" />
                                    <span class="col-green">學生端線上簽名</span>
                                </label>
                            </td>
                        </tr>
                    }
                    <tr>
                        <td>
                            @if (_contract.Status == (int)Naming.ContractServiceStatus.待簽名)
                            {
                                <label class="fancy-checkbox custom-bgcolor-pink">
                                    <input type="checkbox" name="booking">
                                    <span>合約僅能展延乙次，逾期失效。</span>
                                </label>
                            }
                            else if (_contract.Status == (int)Naming.ContractServiceStatus.待審核)
                            {
                                <label class="fancy-checkbox">
                                    <input type="checkbox" name="booking" checked="checked" disabled="disabled">
                                    <span>合約僅能展延乙次，逾期失效。</span>
                                </label>
                            }
                            else
                            {
                                <text><span style="font-size:20px">☑</span> 合約僅能展延乙次，逾期失效。</text>
                            }
                        </td>
                    </tr>
                    <tr>
                        <td>
                            @if (_contract.Status == (int)Naming.ContractServiceStatus.待簽名)
                            {
                                <label class="fancy-checkbox custom-bgcolor-pink">
                                    <input type="checkbox" name="cancel">
                                    <span>展延後不得申請轉讓及退費。</span>
                                </label>
                            }
                            else if (_contract.Status == (int)Naming.ContractServiceStatus.待審核)
                            {
                                <label class="fancy-checkbox">
                                    <input type="checkbox" name="cancel" checked="checked" disabled="disabled">
                                    <span>展延後不得申請轉讓及退費。</span>
                                </label>
                            }
                            else
                            {
                                <text><span style="font-size:20px">☑</span>  展延後不得申請轉讓及退費。</text>
                            }
                        </td>
                    </tr>                                        
                    <tr>
                        <td>
                            @if (_contract.Status < (int)Naming.CourseContractStatus.待審核)
                            {
                                <label class="fancy-checkbox custom-bgcolor-pink">
                                    <input type="checkbox" name="Agree" />
                                    <span class="col-red">我已閱讀並同意超越體能顧問有限公司隱私政策、服務條款、相關使用及消費合約，即表示即日起您同意接受本合約正面及背面條款之相關約束及其責任。</span>
                                </label>
                            }
                            else if (_contract.Status == (int)Naming.CourseContractStatus.待審核)
                            {
                                <label class="fancy-checkbox custom-bgcolor-pink">
                                    <input type="checkbox" name="Agree" checked="checked" disabled="disabled" class="">
                                    <span class="col-red">我已閱讀並同意超越體能顧問有限公司隱私政策、服務條款、相關使用及消費合約，即表示即日起您同意接受本合約正面及背面條款之相關約束及其責任。</span>
                                </label>
                            }
                            else
                            {
                                <text><span style="font-size:20px">☑</span> 我已閱讀並同意超越體能顧問有限公司隱私政策、服務條款、相關使用及消費合約，即表示即日起您同意接受本合約正面及背面條款之相關約束及其責任。</text>
                            }
                        </td>
                    </tr>
                </table>
                <table class="table" style="margin-bottom: 0px">
                    <tr>
                        <td class="p-t-0"></td>
                        <td class="p-0">Beyond Fitness超越體能顧問有限公司</td>
                        @if (_viewModel.Pdf == "1")
                        {
                            <td rowspan="3" width="150px" class="p-0 text-right"><img src="images/sign/seal.png" width="150px" /></td>
                        }
                    </tr>
                    <tr>
                        <td class="p-t-0">
                            學員簽名：
                            @{ ViewBag.SignatureName = "Signature";
                                await Html.RenderPartialAsync("~/Views/ContractConsole/Module/SignHere.cshtml", _owner);}                            
                        </td>
                        <td class="p-0">
                            主管簽核代表：<img src="@(ViewBag.Supervisor != null ? ((UserProfile)ViewBag.Supervisor).UserProfileExtension.Signature :_contract.Supervisor?.UserProfileExtension.Signature)" width="200px" class="modifySignDialog_link">                            
                        </td>
                    </tr>
                    <tr>
                        <td class="p-t-0">
                            @if (_contract.CheckMinorLearner())
                            {
                                <text>家長 / 監護人簽名：</text>
                                ViewBag.SignatureName = "GuardianSignature";
                                await Html.RenderPartialAsync("~/Views/ContractConsole/Module/SignHere.cshtml", _owner);
                            }
                        </td>
                        <td class="p-0">簽約體能顧問：<img src="@(_contract.ServingCoach.UserProfile.UserProfileExtension.Signature)" width="200px" class="modifySignDialog_link" /></td>
                    </tr>
                    <tr>
                        <td class="p-t-0">日期：@(String.Format("{0:yyyy/MM/dd}", _signatureDate))</td>
                        <td class="p-0">日期：@(String.Format("{0:yyyy/MM/dd}", _signatureDate))</td>
                    </tr>                   
                </table>
            </div>
        </div>
    </div>
</div>